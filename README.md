# electiondata-backend

Backend of the Facebook Election Advertising Data transparency tool

## Tech Stack

This app uses:

- [Node JS](https://nodejs.org/en/)
- [Express Framework](https://expressjs.com/)
- [Azure Database for MySQL](https://azure.microsoft.com/en-us/services/mysql/) to store the data extracted from the Facebook Ad Library API
- [Azure App Service](https://azure.microsoft.com/en-us/services/app-service/) to run the data extraction without using local computing resources
- [Azure App Insights](https://azure.microsoft.com/en-us/services/monitor/) to monitor the app service running in the cloud and send notifications in case of issues
- [Azure Blob Storage](https://azure.microsoft.com/en-us/services/storage/blobs/) as a data sink for an Azure Data Factory pipeline that transforms  data from the MySQL database into a comma separated file that can be provided to users in the frontend

## Data Extraction

All data is queried from the Facebook Ad Library API. If you want to extract your own data set, follow the steps below:

1. Access to the Ad Library API requires that you confirm your identity with Facebook. To do so, visit [Facebook's ID confirmation](https://www.facebook.com/id)
2. Create a developer account on [Facebook's developer pages](https://developers.facebook.com/) by clicking "Get Started"
3. Create a new app on the Facebook developer pages by clicking on **My Apps -> Add New App**
4. Go to the [Facebook Graph API Explorer](https://developers.facebook.com/tools/explorer/) and generate an access token for the app with the following permissions:
   - **user_likes, user_status, email, public_profile**
   - **Note:** The regular access token expires after a couple of hours. If you want to avoid dealing with access token refreshs on a regular basis you can use the [Facebook Access Token Debugger](https://developers.facebook.com/tools/debug/accesstoken/) to extend the lifespan of the token. To do so, copy/paste the initial token and then click **"Debug"**. In the updated screen, click on **"Extend Access Token"**. The token generated by this process will give you access to the data for several weeks before it requires renewal.
5. To extract data, either build your own app based on [Facebook's code examples](https://www.facebook.com/ads/library/api/?source=archive-landing-page) or clone this repository (this repo is optimized for deployment on Azure, so all **process.env** variables have to be replaced with regular variables and your own database connection established in order for it to work in a Node development environment)

## Data Cleaning

In order to prepare the data set for analysis and Excel .csv compatibility, perform the steps below:

1.  Remove the access token from the post URLs to avoid other people using your account credentials and update the URL so that users can use them as normal links.

    **SQL Statement**

    UPDATE germany_posts SET ad_snapshot_url = (REPLACE(ad_snapshot_url, '\&access_token=\*\*', ''));
    UPDATE germany_posts SET ad_snapshot_url = (REPLACE(ad_snapshot_url, '\archive/render_ad', 'library'));
    SELECT ad_snapshot_url FROM denmark_posts

2. Clean the data from values that break the .csv formatting. This means properly identifying and encapsulating characters like single quotes, double quotes and backslashes

    **SQL Statement**

    UPDATE *table_name* SET ad_creative_link_title = (REPLACE(ad_creative_link_title, '\\n\\n', ' '));
    UPDATE *table_name* SET ad_creative_link_title = (REPLACE(ad_creative_link_title, '\\n', ' '));
    UPDATE *table_name* SET ad_creative_link_title = (REPLACE(ad_creative_link_title, '\\"', '""'));

    UPDATE *table_name* SET ad_creative_link_caption = (REPLACE(ad_creative_link_caption, '\\n\\n', ' '));
    UPDATE *table_name* SET ad_creative_link_caption = (REPLACE(ad_creative_link_caption, '\\n', ' '));
    UPDATE *table_name* SET ad_creative_link_caption = (REPLACE(ad_creative_link_caption, '\\"', '""'));

    UPDATE *table_name* SET ad_creative_link_description = (REPLACE(ad_creative_link_description, '\\n\\n', ' '));
    UPDATE *table_name* SET ad_creative_link_description = (REPLACE(ad_creative_link_description, '\\n', ' '));
    UPDATE *table_name* SET ad_creative_link_description = (REPLACE(ad_creative_link_description, '\\"', '""'));

    UPDATE *table_name* SET ad_creative_body = (REPLACE(ad_creative_body, '\\n\\n', ' '));
    UPDATE *table_name* SET ad_creative_body = (REPLACE(ad_creative_body, '\\n', ' '));
    UPDATE *table_name* SET ad_creative_body = (REPLACE(ad_creative_body, '\\"', '""'));

## Other helpful SQL statements

### Copy table for backup

CREATE TABLE tbl_new AS SELECT \* FROM tbl_old;

### Check for duplicate entries in ad_snapshot_url column

- Make sure that the data extraction did not produce any duplicate data entries

SELECT ad_snapshot_url, COUNT(_) occurences
FROM germany_posts
Group BY ad_snapshot_url
having COUNT(_) > 1;

## List of Common API Bugs
