# electiondata-backend

Backend of the Facebook Election Advertising Data transparency tool

## Tech Stack

This app uses:

- [Node JS](https://nodejs.org/en/)
- [Express Framework](https://expressjs.com/)
- [Azure Database for MySQL](https://azure.microsoft.com/en-us/services/mysql/) to store the data extracted from the Facebook Ad Library API
- [Azure App Service](https://azure.microsoft.com/en-us/services/app-service/) to run the data extraction without using local computing resources
- [Azure App Insights](https://azure.microsoft.com/en-us/services/monitor/) to monitor the app service running in the cloud and send notifications in case of issues
- [Azure Blob Storage](https://azure.microsoft.com/en-us/services/storage/blobs/) as a data sink for an Azure Data Factory pipeline that transforms data from the MySQL database into a comma separated file that can be provided to users in the frontend

## Data Extraction

All data is queried from the Facebook Ad Library API. If you want to extract your own data set, follow the steps below:

1. Access to the Ad Library API requires that you confirm your identity with Facebook. To do so, visit [Facebook's ID confirmation](https://www.facebook.com/id)
2. Create a developer account on [Facebook's developer pages](https://developers.facebook.com/) by clicking "Get Started"
3. Create a new app on the Facebook developer pages by clicking on **My Apps -> Add New App**
4. Go to the [Facebook Graph API Explorer](https://developers.facebook.com/tools/explorer/) and generate an access token for the app with the following permissions:
   - **user_likes, user_status, email, public_profile**
   - **Note:** The regular access token expires after a couple of hours. If you want to avoid dealing with access token refreshs on a regular basis you can use the [Facebook Access Token Debugger](https://developers.facebook.com/tools/debug/accesstoken/) to extend the lifespan of the token. To do so, copy/paste the initial token and then click **"Debug"**. In the updated screen, click on **"Extend Access Token"**. The token generated by this process will give you access to the data for several weeks before it requires renewal.
5. To extract data, either build your own app based on [Facebook's code examples](https://www.facebook.com/ads/library/api/?source=archive-landing-page) or clone this repository (this repo is optimized for deployment on Azure, so all **process.env** variables have to be replaced with regular variables and your own database connection established in order for it to work in a Node development environment)

## Data Cleaning

In order to prepare the data set for analysis and Excel .csv compatibility, perform the steps below **(See data_cleaning.sql for full list of commands)**:

1. Remove the access token from the post URLs to avoid other people using your account credentials and update the URL so that users can use them as normal links.

    **SQL Statement**

```sql

SELECT
    UPDATE \_table_name* SET  ad_snapshot_url = SUBSTRING_INDEX( ad_snapshot_url, '&access_token=', 1);
    UPDATE \_table_name* SET ad_snapshot_url = (REPLACE(ad_snapshot_url, '\archive/render_ad', 'library'));

```

2. Clean the data from values that break the .csv formatting. This means properly identifying and encapsulating characters like single quotes, double quotes and backslashes

    **SQL Statement**

```sql

SELECT
    UPDATE \_table_name* SET ad*creative_link_title = (REPLACE(ad_creative_link_title, '\\n\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_link_title = (REPLACE(ad_creative_link_title, '\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_link_title = (REPLACE(ad_creative_link_title, '\\"', '""'));  
    UPDATE \_table_name* SET ad*creative_link_caption = (REPLACE(ad_creative_link_caption, '\\n\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_link_caption = (REPLACE(ad_creative_link_caption, '\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_link_caption = (REPLACE(ad_creative_link_caption, '\\"', '""'));  
    UPDATE \_table_name* SET ad*creative_link_description = (REPLACE(ad_creative_link_description, '\\n\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_link_description = (REPLACE(ad_creative_link_description, '\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_link_description = (REPLACE(ad_creative_link_description, '\\"', '""'));  
    UPDATE \_table_name* SET ad*creative_body = (REPLACE(ad_creative_body, '\\n\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_body = (REPLACE(ad_creative_body, '\\n', ' '));  
    UPDATE \_table_name* SET ad*creative_body = (REPLACE(ad_creative_body, '\\"', '""'));  
    UPDATE \_table_name* SET page*name = (REPLACE(page_name, ';', ','));  
    UPDATE \_table_name* SET funding_entity = (REPLACE( funding_entity, ';', ','));


```

## Transformation to CSV (Azure Data Factory)

1. Open [Azure Data Factory](https://adf.azure.com/datafactories)
2. From the home screen, click *Copy Data*
3. Select *FacebookPostDataLink* as the source database
4. Select *country_posts* as the source table
5. Select *FacebookDataLink* as the destination data store
6. Select *thesisdata* as the folder path and name the file (**Important:** Add .csv fileing to file name)
7. File format settings:
   1. File Format: Text Format
   2. Column Delimiter: ;
   3. Row Delimiter: Auto Detect
   4. Add header to file: Yes
   5. No Compression Type
   6. No Escape character
   7. No Quote character
   8. Encoding Default (UTF-8)

## Other helpful SQL statements

### Copy table for backup

```sql SELECT

CREATE TABLE tbl_new AS SELECT \* FROM tbl_old;

```

### Check for duplicate entries in ad_snapshot_url column

- Make sure that the data extraction did not produce any duplicate data entries

```sql SELECT

SELECT ad_snapshot_url, COUNT(_) occurrences
FROM germany_posts
Group BY ad_snapshot_url
having COUNT(_) > 1;

```

### Count number of posts across all tables

```sql

SELECT
(SELECT COUNT(id) FROM australia_posts) +
(SELECT COUNT(id) FROM denmark_posts) +
(SELECT COUNT(id) FROM finland_posts) +
(SELECT COUNT(id) FROM france_posts) +
(SELECT COUNT(id) FROM germany_posts) +
(SELECT COUNT(id) FROM hungary_posts) +
(SELECT COUNT(id) FROM india_posts) +
(SELECT COUNT(id) FROM norway_posts) +
(SELECT COUNT(id) FROM slovakia_posts) +
(SELECT COUNT(id) FROM sweden_posts) +
(SELECT COUNT(id) FROM uk_posts) +
(SELECT COUNT(id) FROM us_posts)

```

## List of Common API Bugs
